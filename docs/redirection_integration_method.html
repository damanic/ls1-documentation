<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">    
<html xmlns="http://www.w3.org/1999/xhtml" class="mac">
<head>
    <title>LemonStand Version 1 - Using a Redirection Integration Method</title>
  <link rel="shortcut icon" href="../favicon.ico" />
  <link href="http://feeds.feedburner.com/lemonstand" type="application/rss+xml" rel="alternate" title="LemonStand blog" />
  <link href="http://feeds.feedburner.com/LemonstandReleaseNotes" type="application/rss+xml" rel="alternate" title="LemonStand release notes" />

  <link rel="stylesheet" type="text/css" href="../ls_css_combine/index.html@file[]=%252Fresources%252Fcss%252Fgrid.css&amp;file[]=%252Fresources%252Fcss%252Fformsframework.css&amp;file[]=%252Fresources%252Fcss%252Fscreen.css&amp;file[]=%252Fresources%252Fcss%252Fjquery.fancybox.css&amp;file[]=%252Fresources%252.css"/>

  <script type="text/javascript" src="../ls_javascript_combine/index.html@file[]=%252Fresources%252Fjs%252Fjquery-1.7.1.min.js&amp;file[]=%252Fresources%252Fjs%252Ftwitter.js&amp;file[]=%252Fresources%252Fjs%252Fjquery.noconflict.js&amp;file[]=%252Fmodules%252Fcms%252Fresources%252Fjavascript%252Ff"></script>
  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,300italic,400italic,700italic|Playfair+Display:400,400italic' rel='stylesheet' type='text/css'>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Language" content="en"/>
  <meta name="keywords" content="" />
  <meta name="description" content="" />

  <meta property="fb:app_id" content="194533163908263"/>


   
  <link type="text/css" rel="stylesheet" href="../resources/shl/styles/shCore.css" />
  <link type="text/css" rel="stylesheet" href="../resources/shl/styles/shThemeRDark.css" />  
  <script type="text/javascript" src="../ls_javascript_combine/index.html@file[]=%252Fresources%252Fjs%252Fjquery-ui-1.8.11.custom.min.js&amp;file[]=%252Fresources%252Fshl%252Fscripts%252FshCore.js&amp;file[]=%252Fresources%252Fshl%252Fscripts%252FshBrushJScript.js&amp;file[]=%252Fresources%252Fs"></script>
  
  <script type="text/javascript">
    SyntaxHighlighter.config.clipboardSwf = '/resources/shl/scripts/clipboard.swf';
    SyntaxHighlighter.all();
    SyntaxHighlighter.defaults.gutter = false;
	SyntaxHighlighter.config.strings.expandSource = "Click to expand the code block";
        
    window.addEvent('domready', function() {
      var $ = jQuery;

      $(".thumbnailWrap a").fancybox({      
         'zoomSpeedIn': 300,
         'zoomSpeedOut': 300,
         'overlayShow': true,
         'titleShow'      : 'true',
         'overlayOpacity': .6
       });
       
       jQuery(".code-tabs").tabs();
    });
  </script>  
  <link rel="stylesheet" type="text/css" href="../resources/css/syntax_highlightier.css@1.css" />
  <link rel="stylesheet" type="text/css" href="../resources/css/wiki.css@1.css" />
  
</head>
<body id="b_help" class="mac">
  <div id="wrapper">
    <div id="headerWrapper">
	  	<div style="background:#333;color:#fff;text-align:center;padding:20px 0;">
	  		<p style="color:#eaeaea">This is the documentation for LemonStand V1, which has been discontinued. You can <a href="https://lemonstand.com/v1tocloud">learn more and upgrade your store here</a>.</p>
	  	</div>
       <div id="header">
      <a href="../index.html" id="headerLogo"><img src="../resources/i/lemonstand_logo.png" alt="LemonStand" /></a>      
      	<p id="contactUs"><span data-icon="&#xe04f;" aria-hidden="true"></span> <a href="tel://1-855-332-0555"><strong>1-855-332-0555</strong></a> &nbsp;&nbsp;&nbsp;<span data-icon="&#xe03e;" aria-hidden="true"> <a href="mailto:sales@lemonstand.com"><strong>sales@lemonstand.com</strong></a>&nbsp;&nbsp;&nbsp; 
      			<span data-icon="&#xe016;" aria-hidden="true"></span> <a id="myaccont_login" href="http://v1.lemonstand.com/myaccount/"><strong>Log In</strong></a>
			</p>

      <div id="navigation">
		<ul>
		<!-- <li class="dropdown"><span>Tour &#9662;</span>
			<ul>
				<li class="first"><a href="/tour/">Take a Tour</a></li>
				<li class="last"><a href="/features/customization/">Features</a></li>
			</ul>
		</li> -->
		<!--<li><a href="/features/">Features</a></li>
		<li><a href="/gallery/">Gallery</a></li>-->
		<li><a href="http://v1.lemonstand.com/marketplace/">Marketplace</a></li>
		<!--<li><a href="/buy/">Pricing</a></li>-->
		<li class="dropdown last"><span>Resources &#9662;</span>
			<ul>              
			  <li class="first"><a href="../docs.html">Documentation</a></li>
			  <li><a href="api_function_and_class_reference/index.html">API</a></li>
			  <li id="n_forum"><a href="http://forum.lemonstand.com">Forum</a></li>
			  <li><a href="http://v1.lemonstand.com/myaccount/tickets/">Technical Support</a></li>
			  <li><a href="http://forum.lemonstandapp.com/index.php?app=tracker&showproject=2">Issue Tracker</a></li>
			  <li><a href="http://v1.lemonstand.com/release-notes/">Release Notes</a></li>
			  <!--<li><a href="/faq/">FAQ</a></li>-->
			  <li class="last"><a href="http://blog.lemonstand.com">Blog</a></li>
			</ul>
		</li>
		<li class="dropdown"><span>Partners &#9662;</span>
			<ul>
				<li class="first"><a href="../partners.html">Certified Partners</a></li>
				<li class="last"><a href="../hire-developers/index.html">Hire a Freelancer</a></li>
			</ul>
		
		</li>
        </ul>
      </div><!--/navigation-->      
      
      	    </div><!--/header-->
    </div><!-- /headerWrapper -->    
    <!-- <div id="topContentWrapper">  
      <div id="topContent">
        <div id="topCol1">
          <h1>LemonStand <span>Documentation</span></h1>
        </div>
      </div>
    </div> -->
    <div id="contentWrapper">  
      <div id="content" class="clearfix">
        <div class="wrap12">
	        <form method="get" action="http://v1.lemonstand.com/docs_search">
        <div id="wiki_search">
          <input name="query" type="text" id="wiki_search_field"/>
          <input type="submit" id="btn-doc-search" class="awesome blue large" value="Search"/>
          <div class="wiki_clear"></div>
        </div>
      </form>
    </div>
  
          <div class="col12 wiki_page_content">
        <div class="wiki_breadcrumbs"><ul class="wiki_toc"><li><a href="front_page.html">LemonStand</a></li><li><a href="developer_guide.html">Developer Guide</a></li><li><a href="extending_lemonstand.html">Extending LemonStand</a></li><li><a href="developing_payment_modules.html">Guide for Developing a Payment Module</a></li><li class="last">Using a Redirection Integration Method</li></ul></div>
        <div id="wiki-cta">
        	<h3>LemonStand Version 1 Has Been Discontinued</h1>
        	<p>This documentation is for LemonStand Version 1. LemonStand is now offered as a cloud-based eCommerce platform.<br> You can try the new LemonStand and <a href="https://lemonstand.com/v1tocloud">learn about upgrading here</a>.</p>
        </div>
        
        <h2>Using a Redirection Integration Method</h2>
        
        <p>This article continues the <a href="developing_payment_modules.html">Developing payment modules</a> article. Please read it before reading this article.&nbsp;Before implementing the redirection integration method, please make sure that your payment gateway supports it.</p>
<p>To begin implementing a new payment module for the redirection integration method, create a payment module class as it described in the <a href="developing_payment_modules.html">previous article</a>. In this article we will show you which specific methods should be added to the module class.</p>
<p>You can download the <strong>redirection payment module template</strong> here: <a href="http://res.lemonstandapp.com/wiki/files/redirection_payment_template.zip">redirection_payment_template.zip</a></p>
<p>The archive contains a module class file and a corresponding directory with partials required for the module. You can rename the module file, PHP class and the directory and begin implementing your own payment module, following the description in this article.</p>
<h3>How the redirection payment method works</h3>
<p>With the redirection payment method, when a customer clicks the Pay button on a LemonStand store, he is redirected to the secure payment form provided by the payment gateway and hosted on the gateway server. Usually the redirection is achieved using a HTML form with the ACTION attribute pointing to the payment gateway payment processing script. The form contains hidden fields providing all information required by the payment gateway - the order amount, order number and some other parameters.</p>
<p>On the secure payment page the customer enters his payment information such as the credit card number, name and address. After that he clicks the Submit button and the gateway processes the payment. Usually after submitting the payment form the customer is automatically redirected back to the store website, however some payment gateways do not support this feature.</p>
<p>Also, many payment gateways can to send a payment notification to the store website, in the background. In PayPal Standard this feature is known as Instant Payment Notification. Payment modules can handle this request and if the transaction was successful, update the order status and mark the order as paid.</p>
<p>You need to read the payment gateway integration guide carefully in order to find out what information has to be sent to the gateway and whether the gateway supports customer return to the store website and whether it supports the store background notification feature.</p>
<h3>Processing gateway response</h3>
<p>In the <a href="developing_payment_modules.html">Developing payment modules</a> article we mentioned that the <strong>process_payment_form()</strong> method should be implemented in all payment module classes. For the redirection integration method this method should be declared but should not contain any code:</p>
<div class="codeblock"><pre class="brush:php; collapse: false">public function process_payment_form($data, $host_obj, $order, $back_end = false)
{
  /*
   * We do not need any code here since payments are processed on the payment gateway server.
   */
}</pre></div><h3>Redirecting a customer to the payment gateway</h3>
<p>In the <a href="developing_payment_modules.html">Developing payment modules</a> article we explained that each payment module should include a payment form partial template file (please see the <strong>Payment form partial templates</strong> section). For redirection payment modules, the payment form should contain only hidden fields. Below is a screenshot of the Beanstream basic integration method payment page:</p>
<p><img class="wiki_image_frame" src="../resources/i/wiki/extending/beanstream_basic_payment_form.png" alt="" /></p>
<p>The "Please click the button to pay with Beanstream" phrase and the button (and a number of hidden fields) are defined in the <strong>front_end_partial.htm</strong> (and <strong>front_end_partial.twig</strong>) partial template file of the Banstream Basic payment module.</p>
<p>Names of hidden fields, their values, and the form ACTION attribute value depend on a payment gateway you use. Below is a code of the Beanstream payment partial template file (front_end_partial.htm, front_end_partial.twig):</p>
<div class="code-tabs" id="beanstream_frontend_template"><ul><li><a href="redirection_integration_method.html#beanstream_frontend_template-php">PHP</a></li><li><a href="redirection_integration_method.html#beanstream_frontend_template-twig">Twig</a></li></ul><div id="beanstream_frontend_template-php"><div class="codeblock"><pre class="brush:php; collapse: true">&lt;p&gt;Please click the button to pay with Beanstream&lt;/p&gt;  
&lt;form action=&quot;&lt;?= $payment_method_obj-&gt;get_form_action($payment_method) ?&gt;&quot; method=&quot;post&quot;&gt;
  &lt;?
    $hidden_fields = $payment_method_obj-&gt;get_hidden_fields($payment_method, $order);
    foreach ($hidden_fields as $name=&gt;$value):
  ?&gt;
    &lt;? if (!is_array($value)): ?&gt;
      &lt;input type=&quot;hidden&quot; name=&quot;&lt;?= $name ?&gt;&quot; value=&quot;&lt;?= h($value) ?&gt;&quot;/&gt;
    &lt;? else: ?&gt;
      &lt;? foreach ($value as $item): ?&gt;
        &lt;input type=&quot;hidden&quot; name=&quot;&lt;?= $name ?&gt;&quot; value=&quot;&lt;?= h($item) ?&gt;&quot;/&gt;
      &lt;? endforeach ?&gt;
    &lt;? endif ?&gt;
  &lt;? endforeach ?&gt;
  &lt;input type=&quot;submit&quot; value=&quot;Pay with Beanstream&quot;/&gt;
&lt;/form&gt;</pre></div></div><div id="beanstream_frontend_template-twig"><div class="codeblock"><pre class="brush:twig; collapse: true">&lt;p&gt;Please click the button to pay with Beanstream&lt;/p&gt;  
&lt;form action=&quot;{{ payment_method_obj.get_form_action(payment_method) }}&quot; method=&quot;post&quot;&gt;
  {% set hidden_fields = payment_method_obj.get_hidden_fields(payment_method, order) %}
  {% for name, value in hidden_fields %}
    {% if value is not array %}
      &lt;input type=&quot;hidden&quot; name=&quot;{{ name }}&quot; value=&quot;{{ value }}&quot;/&gt;
    {% else %}
      {% for item in value %}
        &lt;input type=&quot;hidden&quot; name=&quot;{{ name }}&quot; value=&quot;{{ item }}&quot;/&gt;
      {% endfor %}
    {% endif %}
  {% endfor %}
  &lt;input type=&quot;submit&quot; value=&quot;Pay with Beanstream&quot;/&gt;
&lt;/form&gt;</pre></div></div></div><p>As you can see the code is rather simple. It creates a FORM element and a set of hidden fields. The partial code uses the <strong>$payment_method_obj</strong> variable which refers to the payment module class variable - the class you are developing. The <strong>get_form_action()</strong> and <strong>get_hidden_fields()</strong> methods are defined in the Beanstream payment module class. There are no rules which require you to have these methods defined in the payment module class. You can specify the form ACTION attribute value right in the partial code, and define all hidden fields required by your payment gateway right in the HTML. But this is not a very good idea, because:</p>
<ul>
<li>The payment gateway processing script <strong>could be moved</strong> to another location and your payment module will stop working, because the form ACTION attribute in the already existing payment partials will point to a wrong location. That is why it is better to define a method (<strong>get_form_action()</strong> in this case) inside the module class, which will return a actual URL for the form ACTION attribute.</li>
<li>A set of required fields <strong>could be changed by the payment gateway</strong> and the payment method will stop working. But if you define a method (<strong>get_hidden_fields()</strong> in our case) returning a list of hidden field names and values in your payment module class, the payment module users will only need to update the class declaration, without rewriting the payment partial.</li>
</ul>
<p>The <strong>$payment_method</strong> and <strong>$order</strong> variables are always available on the Pay page (on a page which uses the <strong>shop:pay</strong> action). The <strong>$payment_method</strong> object contains all fields which you defined in the <strong>build_config_ui()</strong> method of your payment module. The <strong>$order</strong> variable is an instance of the <a href="class_shop_order.html">Shop_Order</a> class. This object represents a specific order. You need this variable in order to generate values for hidden fields, for example for the order amount field.</p>
<p>The code below demonstrates the implementation of the get_form_action() method in Beanstream Basic payment module:</p>
<div class="codeblock"><pre class="brush:php; collapse: false">public function get_form_action($host_obj)
{
  return &quot;https://www.beanstream.com/scripts/payment/payment.asp&quot;;
}</pre></div><p>The following code snippet demonstrates the implementation of the <strong>get_hidden_fields()</strong> method of the Beanstream Basic payment module:</p>
<div class="codeblock"><pre class="brush:php; collapse: true">public function get_hidden_fields($host_obj, $order, $backend = false)
{
  $result = array();
  $amount = $order-&gt;total;
  
  $userIp = Phpr::$request-&gt;getUserIp();

  $fields = array();
  $fields['merchant_id'] = $host_obj-&gt;merchant_id;
  $fields['trnOrderNumber'] = $order-&gt;id;
  $fields['trnAmount'] = $amount;

  $approved_page = null;
  if (!$backend)
  {
    $return_page = $order-&gt;payment_method-&gt;receipt_page;
    if ($return_page)
      $approved_page = root_url($return_page-&gt;url.'/'.$order-&gt;order_hash.'?utm_nooverride=1', true);
  }
  else
    $approved_page = root_url(url('/shop/orders/payment_accepted/'.$order-&gt;id.'?utm_nooverride=1&amp;nocache'.uniqid()), true);

  if ($approved_page)
    $fields['approvedPage'] = $approved_page;

  return $fields;
}
</pre></div><p>The method returns an array, containing names and values of hidden fields required by the Beanstream Basic payment integration method. Values of some fields are fetched from the first method parameter, which contains the module configuration field values. Other values are fetched form the order object. The third method parameter (<strong>$backend</strong>) is used for generating the payment form field values for the case when the payment form is accessed from the Administration Area <strong>Pay Order</strong> page. We will describe this case later in this article.</p>
<h4>Sending the receipt page URL to the gateway</h4>
<p>Beanstreab Basic payment gateway supports a customer return to the store website after a successful payment. It requires a hidden field with the <strong>approvedPage</strong> name to be presented in the transaction registration request. This field should be added to the payment form, and therefore the <strong>get_hidden_fields()</strong> method should return it. We can use an URL of the Receipt page for this field value. The <strong>Receipt Page</strong> field is added automatically by LemonStand to configuration forms of all payment methods:</p>
<p><img src="../resources/i/wiki/extending/payment_method_receipt_page.png" alt="" /></p>
<p>The <strong>$receipt_page</strong> field of the <strong>$host_obj</strong> object contains a reference to the <a href="http://v1.lemonstand.com/docs/class_cms_page">Cms_Page</a> object, corresponding a page selected in the <strong>Receipt Page</strong> field of the configuration form. The Cms_Page class has the <strong>$url</strong> field, which contains a URL of the receipt page, <strong>relative to the store root URL</strong>. Payment gateways usually require absolute URLs for return pages. The <strong>root_url()</strong> function returns an absolute URL corresponding a relative URL specified in the first function parameter. The second function parameter should have the TRUE value in order the function to add a protocol prefix to the URL, for example: http://your-store.com/receipt</p>
<p>LemonStand receipt pages (the <strong>shop:payment_receipt</strong> action) require the order identifier (order hash) to be specified in the URL as a last URL segment: http://your-store.com/receipt/<strong>xxx-xxx-xxx</strong>. This can by achieved by adding the <strong>$order-&gt;order_hash</strong> field value to the receipt page URL. Also, the Google Analytics Ecommerce Tracking feature requires the <strong>?utm_nooverride=1</strong> suffix to be added to the URL. The final URL of the receipt page is calculated using the following line of code:</p>
<div class="codeblock"><pre class="brush:php; collapse: false">$approved_page = root_url($return_page-&gt;url.'/'.$order-&gt;order_hash.'?utm_nooverride=1', true);
</pre></div><p>The get_hidden_fields() method and the PHP code in the payment partial generate the following HTML markup on the Pay page for the Beanstream Basic integration method:</p>
<div class="codeblock"><pre class="brush:php; collapse: false">&lt;form action=&quot;https://www.beanstream.com/scripts/payment/payment.asp&quot; method=&quot;post&quot;&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;merchant_id&quot; value=&quot;111111111&quot;/&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;trnOrderNumber&quot; value=&quot;174100&quot;/&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;trnAmount&quot; value=&quot;32.71&quot;/&gt;
  &lt;input type=&quot;hidden&quot; name=&quot;approvedPage&quot; value=&quot;http://your-store.com/receipt/d8f8de1bb531d8de4a93574d9f8adcb1?utm_nooverride=1&quot;/&gt;

  &lt;input type=&quot;submit&quot; value=&quot;Pay with Beanstream&quot;/&gt;
&lt;/form&gt;
</pre></div><h3>Registering a payment notification URL</h3>
<p>As we mentioned earlier in this article, some payment gateways support the <strong>payment notification feature</strong>, which allows the payment gateway to send a payment notification to LemonStand in the background. Payment modules for such payment gateways should be able to process the incoming request, and in case if the transaction was approved by the gateway, mark the order as paid and send it to a specific status, selected in the payment method configuration form.</p>
<p>Payment modules can register so-called <strong>access points</strong>. Access points are special hidden pages, which can be accessed by payment gateways. Each access point has a URL and a method in the payment method class, which handles the URL. Access points should be registered in the <strong>register_access_points()</strong> method of the payment module class. For example, the Beanstream Basic payment module registers a single access point in the following way:</p>
<div class="codeblock"><pre class="brush:php; collapse: false">public function register_access_points()
{
  return array(
    'ls_beasnstream_notification'=&gt;'process_payment_notification'
  );
}</pre></div><p>The method should return an array with keys corresponding access point URLs, and values corresponding the payment module class methods responsible for handling the URLs. The URL of the access point registered in the example above is <strong>ls_beasnstream_notification</strong>. If a store root URL is http://your-store.com, then the access point URL is http://your-store.com/ls_beasnstream_notification. This URL is handled by the <strong>process_payment_notification()</strong>, which should be defined in the payment module class. You can define as many access points as your payment module needs. Access point URLs (the keys of the returning array) cannot contain the slash symbol or spaces.</p>
<p class="wiki_note">Important! Payment method access point names should start with the ls_ prefix.</p>
<p>Access point handling methods should accept a single function parameter. LemonStand uses this parameter for passing segments of the URL to the method. For example, if the access point URL is http://your-store.com/ls_beasnstream_notification, and the invoked URL is http://your-store.com/ls_beasnstream_notification/12/31, the method parameter will contain an array with 2 elements - 12 and 31.</p>
<p>Some payment gateways require the payment notification URL to be presented in the payment request, as a hidden field. For this case you can implement the same approach as we described for the <strong>approvedPage</strong> field above. Other payment gateways, including the Beanstream Basic, allow to specify the payment notification URL in the payment gateway configuration form (inside the payment gateway merchant account).</p>
<p>Usually payment gateways send payment notifications as a POST request, and all transaction-related information is available as POST fields. Below is an implementation of the Beanstream Basic payment notification handling method:</p>
<div class="codeblock"><pre class="brush:php; collapse: true">public function process_payment_notification($params)
{
  $fields = $_POST;
  $order = null;

  try
  {
    /*
     * Find order and load payment method settings
     */

    $order_id = post('trnOrderNumber');
    if (!$order_id)
      throw new Phpr_ApplicationException('Order not found');

    $order = Shop_Order::create()-&gt;find($order_id);
    if (!$order)
      throw new Phpr_ApplicationException('Order not found.');

    if (!$order-&gt;payment_method)
      throw new Phpr_ApplicationException('Payment method not found.');

    $order-&gt;payment_method-&gt;define_form_fields();
    $payment_method_obj = $order-&gt;payment_method-&gt;get_paymenttype_object();
  
    if (!($payment_method_obj instanceof Shop_Beanstream_Basic_Payment))
      throw new Phpr_ApplicationException('Invalid payment method.');

    /*
     * Validate the transaction
     */
    
    if (post('trnAmount') != $order-&gt;total)
      throw new Phpr_ApplicationException('Invalid transaction data.');
  
    if (post('trnApproved') != 1)
      throw new Phpr_ApplicationException('Transaction not approved: '.post('messageText'));
    
    if ($order-&gt;set_payment_processed())
    {
      Shop_OrderStatusLog::create_record($order-&gt;payment_method-&gt;order_status, $order);
      $this-&gt;log_payment_attempt($order, 'Successful payment', 1, array(), $fields, null);
    }
  }
  catch (Exception $ex)
  {
    if ($order)
      $this-&gt;log_payment_attempt($order, $ex-&gt;getMessage(), 0, array(), $fields, null);

    throw new Phpr_ApplicationException($ex-&gt;getMessage());
  }
}</pre></div><p>The code has 3 functional parts.</p>
<h4>Validating the incoming request</h4>
<p>First, the code checks POST fields and validates the request. Each payment gateway posts different data in payment notification requests and you need to refer to your payment gateway integration guide in order to learn which POST fields are available. The code in the example above loads the order identifier from the <strong>trnOrderNumber</strong> POST field. This field is specific for the Beanstream gateway. After that the code loads the <strong>$order</strong> object from the database and performs some additional checks.</p>
<h4>Updating the order status and logging the payment attempt</h4>
<p>After validating the request data, the method checks the transaction status, received from the payment gateway. If the transaction has been successfully processed by the payment gateway, the code updates the order status, marks the order as paid and adds the payment attempt log record. To change the order status the code calls the <strong>Shop_OrderStatusLog::create_record()</strong> method:</p>
<div class="codeblock"><pre class="brush:php; collapse: false">Shop_OrderStatusLog::create_record($order-&gt;payment_method-&gt;order_status, $order);</pre></div><p>The <strong>Shop_OrderStatusLog::create_record()</strong> method has 2 parameters - the destination order status identifier and the order object. The order status identifier is available through the <strong>$order-&gt;payment_method-&gt;order_status</strong> field. The <strong>$order-&gt;payment_method</strong> field contains all fields defined in the <strong>build_config_ui()</strong> method of the payment module, which we described in the <a href="developing_payment_modules.html">previous article</a>.</p>
<p>To mark the order as paid the code uses the following call:</p>
<div class="codeblock"><pre class="brush:php; collapse: false">$order-&gt;set_payment_processed();</pre></div><p>And finally, the method creates the payment attempt using the following call:</p>
<div class="codeblock"><pre class="brush:php; collapse: false">$this-&gt;log_payment_attempt($order, 'Successful payment', 1, array(), $fields, null);</pre></div><p>The <strong>log_payment_attempt()</strong> method is a built-in method of any payment module class, defined in the Shop_PaymentType class. The method has the following parameters:</p>
<ul>
<li><strong>$order</strong> - an order object to log the payment attempt for.</li>
<li><strong>$message</strong> - a message string, describing the attempt result. For successful payments you can use the "Successful payment" string. For error conditions use an error message returned by the payment gateway.</li>
<li><strong>$is_successful</strong> - indicates whether the attempt was successful.</li>
<li><strong>$request_array</strong> - a list of fields which the payment module posted to the payment gateway. For redirection integration methods, we do not send any requests directly to the payment gateway, so you can pass an empty array value to this parameter.</li>
<li><strong>$response_array</strong> - a list of fields received from the payment gateway, as array.</li>
<li><strong>$response_text</strong> - a raw response text received from the payment gateway. In some cases the response text is not available, and you can pass the NULL value to the parameter.</li>
<li><strong>$ccv_response_code</strong>&nbsp;-&nbsp;card code verification response code, optional.</li>
<li><strong>$ccv_response_text </strong>&nbsp;-&nbsp;card code verification response text, optional.</li>
<li><strong>$avs_response_code</strong>&nbsp;-&nbsp;address verification response code, optional.</li>
<li><strong>$avs_response_text</strong> -&nbsp;address verification response text, optional.</li>
</ul>
<p>Payment attempts which you log using the <strong>log_payment_attempt()</strong> method are displayed on the Order Preview page:</p>
<p><img src="../resources/i/wiki/extending/payment_attempt_list.png" alt="" /></p>
<p>LemonStand users can click on a payment attempt record and view all details which you specified in the <strong>log_payment_attempt()</strong> method call:</p>
<p><img src="../resources/i/wiki/extending/payment_attempt_details.png" alt="" /></p>
<p class="wiki_note">As payment attempt details can be accessed by LemonStand users, you should remove any credit-card and payment gateway API credentials data from the request and response arrays and from the gateway raw response text.</p>
<p>With the Beanstream basic integration method we do not send any credit card details to the gateway, and the gateway do not post card information or API credentials to the payment notification access point, so we do not need to remove any elements from the gateway response array. For other cases you can use the PHP <strong>unset()</strong> function for removing specific elements from arrays. Usually we define a special method which strips specific fields from a given array, and call the method for request and response array. For example, below is a data cleaning method from the HSBC payment module:</p>
<div class="codeblock"><pre class="brush:php; collapse: true">private function prepare_fields_log($fields)
{
  unset($fields['ClientId']);
  unset($fields['Name']);
  unset($fields['Password']);
  unset($fields['Cvv2Val']);
  if (isset($fields['Number']))
    $fields['Number'] = '...'.substr($fields['Number'], -4);
  
  return $fields;
}
</pre></div><p>It removes the API credential fields from the input array, and leaves only 4 last digits in credit card numbers. We use this method to process the request and response arrays in the following way:</p>
<div class="codeblock"><pre class="brush:php; collapse: false">$this-&gt;log_payment_attempt($order, 
  'Successful payment', 
  1, 
  $this-&gt;prepare_fields_log($request_fields), 
  $this-&gt;prepare_fields_log($response_fields), 
  null);</pre></div><h4>Logging invalid requests</h4>
<p>The final part of the payment notification handling method catches all errors which could occur inside the method and logs invalid request using the <strong>log_payment_attempt()</strong> method. The important part of the error handling code is the PHP condition which checks whether the order was loaded from the database. Only in this case the method logs the payment attempt:</p>
<div class="codeblock"><pre class="brush:php; collapse: false">if ($order)
  $this-&gt;log_payment_attempt($order, $ex-&gt;getMessage(), 0, array(), $fields, null);
</pre></div><h3>Back-end payment forms</h3>
<p>All payment modules must provide a form for paying an order from the LemonStand Administration Area. Payment modules which implement the redirection integration method must provide a special partial file, which should be placed to the payment module directory. The partial file can have any name, but we usually use the <strong>backend_payment_form.htm</strong> file name. The back-end payment partial should be registered in the <strong>get_info()</strong> method of the payment module class, using the <strong>custom_payment_form</strong> parameter:</p>
<div class="codeblock"><pre class="brush:php; collapse: false">public function get_info()
{
  return array(
    'name'=&gt;'Beanstream Basic Integration',
    'description'=&gt;'A basic HTTP POST integration. The customer&rsquo;s browser will be pointed to the Beanstream server at the time of processing.',
    'custom_payment_form'=&gt;'backend_payment_form.htm'
  );
}</pre></div><p>Back-end payment partials are rendered by LemonStand on the Pay page in the Administration Area. For example, this is a screenshot of the Pay page for an order which uses the Beanstream Basic integration method:</p>
<p><img class="wiki_image_frame" src="../resources/i/wiki/extending/beanstream_basic_backend_payment.png" alt="" /></p>
<p>The "Click the button to pay with Beanstream" label, the "Pay with Beanstream" buttons and a set of hidden fields are defined in the back-end payment form partial. Below is a code of the Beanstream Basic back-end payment form partial:</p>
<div class="codeblock"><pre class="brush:php; collapse: false">&lt;form action=&quot;&lt;?= $payment_method_obj-&gt;get_form_action($payment_method) ?&gt;&quot; method=&quot;post&quot;&gt;
  &lt;?
    $hidden_fields = $payment_method_obj-&gt;get_hidden_fields($payment_method, $order, true);
    foreach ($hidden_fields as $name=&gt;$value):
  ?&gt;
    &lt;input type=&quot;hidden&quot; name=&quot;&lt;?= $name ?&gt;&quot; value=&quot;&lt;?= h($value) ?&gt;&quot;/&gt;
  &lt;? endforeach ?&gt;
  &lt;?= backend_button('Pay with Beanstream', array('href'=&gt;&quot;#&quot;, 'onclick'=&gt;'$(this).getForm().submit(); return false;')) ?&gt;
&lt;/form&gt;
</pre></div><p>The code is very similar to the front-end payment partial template file described above. But there are some differences. In the <strong>get_hidden_fields()</strong> method call the last parameter is TRUE. It notifies the <strong>get_hidden_fields()</strong> method that the form is generated for the Administration Area (in contrast to the front-end website Pay page). If you look to the method implementation above, you will see that it checks the $backend parameter value, and if it is TRUE, it sets the <strong>approvedPage</strong> field value using the following code:</p>
<div class="codeblock"><pre class="brush:php; collapse: false">$approved_page = root_url(url('/shop/orders/payment_accepted/'.$order-&gt;id.'?utm_nooverride=1&amp;nocache'.uniqid()), true);</pre></div><p>The <strong>/shop/orders/payment_accepted/</strong> page is a page inside the Administration Area. It displays the "The order has been successfully paid" message. Always use the code demonstrated above for obtaining a URL of a return page for the back-end payment forms.</p>
<p>The second difference between the back-end and front-end payment form partials is the Pay button code. In the Administration Area we use the <strong>backend_button()</strong> function for generating a standard Administration Area button. Use the code demonstrated above for all payment methods.</p>
<h3>Conclusion</h3>
<p>The complexity of implementing of a specific payment module depends on complexity of the payment gateway integration API and on the quality of the payment gateway integration guide. LemonStand API allows to implement almost any payment module. We cannot provide you with all possible solutions and code examples in a single Wiki article. We suggest you to explore existing payment modules and learn how they solve different tasks. Below is a list of some existing redirection payment modules</p>
<ul>
<li><strong>PayPal Standard</strong> - this module is interesting because it implements 2 access points - for the Instant Payment Notification and for the Auto Return PayPal features. The module file name is shop_paypal_pro_payment.php.</li>
<li><strong>E-xact Hosted Checkout</strong> - the module implements an access point for processing the E-xact Silent Post and Return features. The file name is shop_exact_hosted_checkout_payment.php.</li>
</ul>
        
        <p>Next: <a href="server_to_server_integration_method.html">Using a Server-to-Server Integration Method</a><br/>Previous: <a href="developing_payment_modules.html">Guide for Developing a Payment Module</a><br/>Return to <a href="developing_payment_modules.html">Guide for Developing a Payment Module</a></p>
        
              </div>
      
            <div class="wrap12 commentsWrap">
		<div id="thread"></div>
		<div id="disqus_thread"></div>
		<script type="text/javascript">
		var disqus_identifier = "wiki_page_193"; //[Optional but recommended: Define a unique identifier (e.g. post id or slug) for this thread]
		var disqus_url = "http://v1.lemonstand.com/docs/redirection_integration_method/";
		var disqus_title = "Using a Redirection Integration Method";
		(function() {
		 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		 dsq.src = 'http://lemonstand.disqus.com/embed.js';
		 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
		</script>
		<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=lemonstand">comments powered by Disqus.</a></noscript>

      </div><!--/commentsWrap-->
              
          </div><!--/content-->
    </div><!-- /contentWrapper -->
</div><!--/wrapper-->
<div id="footer">
  <div id="footerContent">
    <div class="wrap12">
	    <div class="col4">
	      	<ul>
			<li id="" class="menuHead level1"><span class="title">Learn About The New LemonStand Cloud</span></li><li id="" class="level1"><a href="https://lemonstand.com" title="More information" class="title">More information</a></li><li id="" class="level1"><a href="https://lemonstand.com/showcase" title="LemonStand Showcase" class="title">LemonStand Showcase</a></li><li id="" class="level1"><a href="https://lemonstand.com/features" title="LS Cloud Features" class="title">LS Cloud Features</a></li><li id="" class="level1"><a href="https://lemonstand.com/pricing" title="LS Cloud Pricing" class="title">LS Cloud Pricing</a></li><li id="" class="level1"><a href="https://lemonstand.com/signup" title="LS Cloud Free Trial" class="title">LS Cloud Free Trial</a></li><li id="" class="level1"><a href="http://blog.lemonstand.com" title="eCommerce Blog" class="title">eCommerce Blog</a></li>			</ul>
	    </div>
	    <!--<div class="col2">
	      	<ul>
			<li id="" class="menuHead level1"><span class="title">About V1</span></li><li id="" class="level1"><a href="/gallery-oldurl" title="V1 Customer Gallery" class="title">V1 Customer Gallery</a></li><li id="" class="level1"><a href="/buy" title="Buy V1 License" class="title">Buy V1 License</a></li><li id="" class="level1"><a href="/freetrial" title="V1 Trial License" class="title">V1 Trial License</a></li>			</ul>
	    </div>-->
	    <div class="col2">
	      	<ul>
			<li id="" class="menuHead level1"><span class="title">V1 Community</span></li><li id="" class="level1"><a href="http://v1.lemonstand.com/marketplace" title="Marketplace" class="title">Marketplace</a><ul><li id="" class="level2"><a href="http://v1.lemonstand.com/marketplace/category/modules/" title="V1 Modules" class="title">V1 Modules</a></li><li id="" class="level2"><a href="http://v1.lemonstand.com/marketplace/category/themes/" title="V1 Themes" class="title">V1 Themes</a></li><li id="" class="level2"><a href="http://v1.lemonstand.com/marketplace/ideas/all/" title="V1 Ideas" class="title">V1 Ideas</a></li></ul></li><li id="" class="level1"><a href="../partners.html" title="Partners" class="title">Partners</a></li><li id="" class="level1"><a href="http://forum.lemonstandapp.com/" title="Community Forums" class="title">Community Forums</a></li>			</ul>
	    </div>
	    <div class="col3">
	      	<ul>
			<li id="" class="menuHead level1"><span class="title">V1 Support</span></li><li id="" class="level1"><a href="../myaccount.html" title="My Account" class="title">My Account</a><ul><li id="" class="level2"><a href="http://v1.lemonstand.com/myaccount/tickets" title="V1 Support Tickets" class="title">V1 Support Tickets</a></li></ul></li><li id="" class="level1"><a href="../docs.html" title="Documentation" class="title">Documentation</a><ul><li id="" class="level2"><a href="ecommerce_guide.html" title="V1 Merchant's Guide" class="title">V1 Merchant's Guide</a></li><li id="" class="level2"><a href="developer_s_guide/index.html" title="V1 Developer's Guide" class="title">V1 Developer's Guide</a></li><li id="" class="level2"><a href="../api.html" title="V1 API Docs" class="title">V1 API Docs</a></li></ul></li>			</ul>
	    </div>
	    <!--<div class="col3 share">
	    	<div>
		    	<a href="https://twitter.com/lemonstand" class="twitter-follow-button" data-show-count="false">Follow @lemonstand</a>
		    	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
	    	</div>
	    	
	    	<div>
	    		<iframe src="//www.facebook.com/plugins/like.php?href=http%3A%2F%2Ffacebook.com%2Flemonstand&amp;send=false&amp;layout=button_count&amp;width=200&amp;show_faces=false&amp;font=arial&amp;colorscheme=light&amp;action=like&amp;height=21&amp;appId=194533163908263" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:90; height:21px;" allowTransparency="true"></iframe>
	    	</div>
	    	

	    	<div class="g-plusone" data-size="medium" data-href="http://lemonstand.com"></div>
	    	
	    	<div id="footer_newsletter">
	    		<h5>Get Email updates (It's Free)</h5>
	    		<form method="post" action="/" onsubmit="return subscribe_email(this, 'footer_newsletter', 'site:footer:newsletter')">
				    <input type="hidden" name="format" value="h" />
				    <input type="text" name="email" value="Email Address" id="optInEmail" class="formField" />
				    <input type="submit" value="Sign-Up" id="optInBtn" class="button small yellow" />
				    <p>We'll keep your email safe. Promise.</p>
			  </form>
  			</div>
	    </div>-->
    </div>
    <div class="col12 terms">
      <p>Copyright &copy; 2018 LemonStand eCommerce Inc. All Rights Reserved. <a href="../tos/index.html">Terms &amp; Conditions</a> | <a href="../privacy-policy/index.html">Privacy Policy</a></p>
    </div>
  </div><!--/footerContent-->
  <div style="clear: both; width: 960p;">&nbsp;</div>
</div><!--/footer-->



<!-- Place this tag after the last +1 button tag. -->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<!-- affiliate -->
<script type="text/javascript"><!--
document.write(unescape("%3Cscript id='pap_x2s6df8d' src='" + (("https:" == document.location.protocol) ? "https://" : "http://") + 
"affiliate.lemonstandapp.com/scripts/trackjs.js' type='text/javascript'%3E%3C/script%3E"));//-->
</script>
<script type="text/javascript"><!--
PostAffTracker.setAccountId('default1');
try {
PostAffTracker.track();
} catch (err) { }
//-->
</script>
<!-- /affiliate -->
<script type="text/javascript">
  // Track GA variables
  var _gaq = _gaq || [];
  
  _gaq.push(['_setCustomVar', 1, 'Visitor Type', 'Guest', 1]);
  _gaq.push(['_setCustomVar', 2, 'Partner', 'No', 1]);
  
  
  _gaq.push(['_setCustomVar', 4, 'Author', 'No', 1]);
</script>

<!--CrazyEgg-->
<script type="text/javascript">
setTimeout(function(){var a=document.createElement("script");
var b=document.getElementsByTagName("script")[0];
a.src=document.location.protocol+"//dnn506yrbagrg.cloudfront.net/pages/scripts/0000/6128.js?"+Math.floor(new Date().getTime()/3600000);
a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
</script>
	<!--AdRoll-->
	<script type="text/javascript">
	adroll_adv_id = "QICDG4SA4BCD7BH2B4E4OA";
	adroll_pix_id = "BZOADVG5ZFG4XATGXBKRV7";
	(function () {
	var oldonload = window.onload;
	window.onload = function(){
	   __adroll_loaded=true;
	   var scr = document.createElement("script");
	   var host = (("https:" == document.location.protocol) ? "https://s.adroll.com" : "http://a.adroll.com");
	   scr.setAttribute('async', 'true');
	   scr.type = "text/javascript";
	   scr.src = host + "/j/roundtrip.js";
	   ((document.getElementsByTagName('head') || [null])[0] ||
	    document.getElementsByTagName('script')[0].parentNode).appendChild(scr);
	   if(oldonload){oldonload()}};
	}());
	</script>
	<!-- Pathful tracking -->
<script>
var PF_APPID = "3b5537e5529b89e5";
setTimeout(function(){ var d = document; 
s = d.createElement('script');
s.type = 'text/javascript'; s.async = true;
s.src = ("https:" == document.location.protocol) ? 
"https://ssl.pathful.com/js/scripts/secure.js"
: "http://s.pathful.com/js/scripts/capture.js";
document.body.appendChild(s, d);
}, 1);
</script>

</body>
 </html>